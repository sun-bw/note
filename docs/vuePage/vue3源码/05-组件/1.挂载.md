### æŒ‚è½½
å…ˆæ¥çœ‹ä¸€ä¸‹ä½¿ç”¨æ–¹å¼
```ts
import { h, ref, createApp, render } from '../dist/vue.esm.js'
const Comp = {
    render() {
        return h('div', 'hello world')
    }
}
createApp(Comp).mount('#app')
```
å…ˆå¤„ç†ä¸€ä¸‹`createVNode`ä¸­çš„ç»„ä»¶ç±»å‹
```ts
// vnode.ts
export function createVNode(type, props?, children = null) {
    let shapeFlag = 0

    if (isString(type)) {
        // div span p h1
        shapeFlag = ShapeFlags.ELEMENT // 1
    } else if (isObject(type)) {
        // type æ˜¯ ä¸€ä¸ªå¯¹è±¡ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªç»„ä»¶
        // æœ‰çŠ¶æ€ç»„ä»¶
        shapeFlag = ShapeFlags.STATEFUL_COMPONENT
    }

    // çœç•¥éƒ¨åˆ†ä»£ç ...

    const vnode = {
        /* çœç•¥éƒ¨åˆ†ä»£ç ... */
    }

    return vnode
}
```
ç»„ä»¶å’Œå…ƒç´ ã€æ–‡æœ¬ä¸€æ ·ï¼Œéƒ½å­˜åœ¨ä¸¤ç§æƒ…å†µï¼ŒæŒ‚è½½å’Œæ›´æ–°ï¼š
```ts
const patch = (n1, n2, container, anchor = null) => {
    // çœç•¥éƒ¨åˆ†ä»£ç ...
    const { shapeFlag, type } = n2

    switch (type) {
        case Text:
        processText(n1, n2, container, anchor)
        break
        default:
        if (shapeFlag & ShapeFlags.ELEMENT) {
            // å¤„ç† dom å…ƒç´  div span p h1
            processElement(n1, n2, container, anchor)
        } else if (shapeFlag & ShapeFlags.COMPONENT) {
            // ğŸ’¡ å¤„ç†ç»„ä»¶çš„é€»è¾‘
            processComponent(n1, n2, container, anchor)
        }
    }
}
```
åˆ›å»º`processComponent`å‡½æ•°å¤„ç†ç»„ä»¶çš„æŒ‚è½½å’Œæ›´æ–°ï¼š
```ts
const processComponent = (n1, n2, container, anchor) => {
    if (n1 == null) {
        // æŒ‚è½½
        // åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª mountComponent å‡½æ•°ï¼Œæ¥å®ŒæˆæŒ‚è½½
        mountComponent(n2, container, anchor)
    } else {
        // æ›´æ–°
    }
}
```
åˆ›å»º`mountComponent`å‡½æ•°ï¼š
```ts
const mountComponent = (vnode, container, anchor) => {
    /**
     * 1. åˆ›å»ºç»„ä»¶å®ä¾‹
     * 2. åˆå§‹åŒ–ç»„ä»¶çŠ¶æ€
     * 3. å°†ç»„ä»¶æŒ‚è½½åˆ°dom
     */
    // åˆ›å»ºç»„ä»¶å®ä¾‹
    const instance = createComponentInstance(vnode)
    // åˆå§‹åŒ–ç»„ä»¶çŠ¶æ€
    setupComponent(instance)
    // è°ƒç”¨renderæ‹¿åˆ°subTreeï¼Œ thisåº”è¯¥æŒ‡å‘setupState
    const subTree = instance.render.call(instance.setupState)
    // å°†subTreeæŒ‚è½½åˆ°é¡µé¢
    patch(null, subTree, container, anchor)
}
```
æ–°å»º`component.ts`æ–‡ä»¶ï¼Œåˆ›å»º`createComponentInstance`ï¼Œ`setupComponent`å‡½æ•°:
```ts
import { proxyRefs } from '@vue/reactivity'

/**
 * åˆ›å»ºç»„ä»¶å®ä¾‹
 */
export function createComponentInstance(vnode) {
    const { type } = vnode
    const instance = {
        type,
        vnode,
        // æ¸²æŸ“å«ç³Š
        render: null,
        // setupè¿”å›çš„çŠ¶æ€
        setupState: null,
        props: {},
        attrs: {},
        // å­æ ‘ï¼Œrenderçš„è¿”å›å€¼
        subTree: null,
        // æ˜¯å¦å·²ç»æŒ‚è½½
        isMounted: false,
    }

    return instance
}

/**
 * åˆå§‹åŒ–ç»„ä»¶
 */
export function setupComponent(instance) {
    const { type } = instance
    const setupResult = proxyRefs(type.setup())
    // æ‹¿åˆ°setupè¿”å›çš„çŠ¶æ€
    instance.setupState = setupResult
    // å°†renderå‡½æ•°ç»™instance
    instance.render = type.render
}
```
è¿™æ ·å°±å®Œæˆäº†æŒ‚è½½é€»è¾‘ï¼Œå½“æ•°æ®å˜åŒ–çš„æ—¶å€™ï¼Œä¹Ÿä¼šè§¦å‘æ›´æ–°é€»è¾‘ã€‚æ³¨æ„è¿™ä¸ªæ›´æ–°å’Œæˆ‘ä»¬`processComponent`ä¸­çš„æ›´æ–°æ˜¯ä¸åŒçš„ï¼Œè¿™é‡Œæ˜¯ç»„ä»¶çš„æ›´æ–°ï¼Œè€Œ`processComponent`ä¸­çš„æ˜¯ç»„ä»¶çš„æŒ‚è½½å’Œçˆ¶ç»„ä»¶ä¼ é€’çš„å±æ€§å˜åŒ–å¯¼è‡´çš„æ›´æ–°ã€‚åé¢ä¼šè¯´åˆ°ã€‚